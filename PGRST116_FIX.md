# معالجة خطأ PGRST116 في تحديث القصاصات

## المشكلة
كان يحدث خطأ `PGRST116` عند محاولة تحديث قصاصات الراتب والحوافز والأرباح. هذا الخطأ يعني أن قاعدة البيانات لا تجد القصاصة المطلوب تحديثها (0 rows returned).

## الأسباب المحتملة
1. **عدم تطابق الـ ID**: الـ ID المحلي لا يتطابق مع الـ ID في قاعدة البيانات
2. **حذف القصاصة**: القصاصة تم حذفها من قاعدة البيانات ولكن لا تزال موجودة محلياً
3. **مشاكل المزامنة**: عدم تزامن البيانات بين التخزين المحلي وقاعدة البيانات

## الحلول المطبقة

### 1. التحقق المسبق من وجود القصاصة
قبل محاولة التحديث، يتم التحقق من وجود القصاصة في قاعدة البيانات:

```typescript
// جلب جميع القصاصات من قاعدة البيانات
const existingSlips = await databaseService.getSalarySlips(currentUserId);
const dbSlip = existingSlips.find(s => s.id === existingSlip.id);

if (!dbSlip) {
  // إنشاء قصاصة جديدة إذا لم توجد
  const newSlip = await databaseService.saveSalarySlip({...});
}
```

### 2. معالجة خطأ PGRST116
إذا حدث خطأ PGRST116، يتم إنشاء قصاصة جديدة تلقائياً:

```typescript
const isPGRST116 = dbError && typeof dbError === 'object' && 'code' in dbError && dbError.code === 'PGRST116';

if (isPGRST116) {
  // إنشاء قصاصة جديدة
  const newSlip = await databaseService.saveSalarySlip({...});
}
```

### 3. حماية القصاصات المحلية الجديدة ⭐ **جديد**
تم تحسين دالة `cleanupLocalData` لحماية القصاصات المحلية الجديدة التي لا تحتوي على ID:

```typescript
const cleanedIncentiveSlips = incentiveSlips.filter(slip => {
  // إذا لم يكن للقصاصة ID، فهي قصاصة محلية جديدة - نحتفظ بها
  if (!slip.id) {
    console.log('Keeping local incentive slip without ID:', slip);
    return true;
  }
  // إذا كان للقصاصة ID، نتأكد من وجودها في قاعدة البيانات
  const existsInDB = validIncentiveIds.includes(slip.id);
  return existsInDB;
});
```

### 4. مزامنة القصاصات المحلية الجديدة ⭐ **جديد**
تم إضافة دالة `syncPendingLocalData` لمزامنة القصاصات المحلية الجديدة مع قاعدة البيانات:

```typescript
const syncPendingLocalData = async () => {
  // البحث عن القصاصات التي لا تحتوي على ID
  for (let i = 0; i < incentiveSlips.length; i++) {
    const slip = incentiveSlips[i];
    if (!slip.id) {
      // مزامنة القصاصة المحلية مع قاعدة البيانات
      const newSlip = await databaseService.saveIncentiveSlip({...});
      // تحديث الـ ID في القائمة المحلية
      updatedSlips[i] = { ...slip, id: newSlip.id };
    }
  }
}
```

### 5. دالة معالجة الأخطاء المركزية
تم إضافة دالة `handleDatabaseError` لمعالجة جميع أخطاء قاعدة البيانات بشكل موحد:

```typescript
const handleDatabaseError = async (error: any, operation: string, slipData: any, index?: number) => {
  const isPGRST116 = error && typeof error === 'object' && 'code' in error && error.code === 'PGRST116';
  
  if (isPGRST116) {
    // إنشاء قصاصة جديدة حسب النوع
    if (operation === 'updateSalarySlip') {
      // إنشاء قصاصة راتب جديدة
    } else if (operation === 'updateIncentiveSlip') {
      // إنشاء قصاصة حافز جديدة
    }
  }
}
```

## التحسينات المطبقة

### 1. في `updateSalarySlip`
- التحقق المسبق من وجود القصاصة
- معالجة خطأ PGRST116
- إنشاء قصاصة جديدة إذا لزم الأمر

### 2. في `updateIncentiveSlip`
- نفس التحسينات المطبقة على قصاصات الراتب
- تحسين حساب أرصدة الإجازات

### 3. في `updateProfitsSlip`
- نفس التحسينات المطبقة على قصاصات الراتب والحوافز

### 4. في `loadFromDatabase` ⭐ **محدث**
- إضافة استدعاء `syncPendingLocalData` بدلاً من `cleanupLocalData`
- تحسين تحميل البيانات من قاعدة البيانات
- مزامنة القصاصات المحلية الجديدة

### 5. في `linkToDatabase`
- إضافة استدعاء دالة المزامنة عند ربط الحساب

## النتائج المتوقعة

1. **عدم ظهور خطأ PGRST116**: سيتم معالجة الخطأ تلقائياً
2. **حماية القصاصات المحلية**: لن يتم حذف القصاصات المحلية الجديدة
3. **مزامنة تلقائية**: القصاصات المحلية ستتم مزامنتها عند عودة الاتصال
4. **استقرار التطبيق**: لن يتوقف التطبيق عند حدوث أخطاء في قاعدة البيانات
5. **تجربة مستخدم أفضل**: المستخدم لن يرى أخطاء غير مفهومة

## سيناريوهات الاختبار

### السيناريو 1: إضافة قصاصة بدون إنترنت
1. قطع الاتصال بالإنترنت
2. إضافة قصاصة جديدة
3. إعادة الاتصال بالإنترنت
4. **النتيجة المتوقعة**: القصاصة ستتم مزامنتها تلقائياً

### السيناريو 2: تعديل قصاصة بدون إنترنت
1. قطع الاتصال بالإنترنت
2. تعديل قصاصة موجودة
3. إعادة الاتصال بالإنترنت
4. **النتيجة المتوقعة**: التعديلات ستتم مزامنتها تلقائياً

### السيناريو 3: إغلاق التطبيق وإعادة فتحه
1. إضافة قصاصات بدون إنترنت
2. إغلاق التطبيق
3. إعادة فتح التطبيق مع إنترنت
4. **النتيجة المتوقعة**: جميع القصاصات ستتم مزامنتها

## ملاحظات مهمة

- ✅ **تم الحفاظ على جميع البيانات المحلية**
- ✅ **لا يتم فقدان أي بيانات**
- ✅ **التطبيق يعمل بشكل طبيعي حتى لو حدث خطأ في قاعدة البيانات**
- ✅ **يتم إظهار رسالة نجاح المزامنة فقط عند نجاح العملية**
- ✅ **القصاصات المحلية الجديدة محمية من الحذف**
- ✅ **مزامنة تلقائية عند عودة الاتصال بالإنترنت** 