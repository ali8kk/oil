# هجرة قاعدة البيانات الجديدة

## نظرة عامة

تم إعادة هيكلة قاعدة البيانات بالكامل لتطبق النظام المطلوب:

### التغييرات الرئيسية:
1. **ID المستخدمين**: تم تغييرها من UUID إلى أرقام تسلسلية (1, 2, 3, ...)
2. **نظام الربط والاستعادة**: تم تحسينه ليعمل بالطريقة المطلوبة
3. **الرسائل**: جميع الرسائل باللغة العربية
4. **الواجهة**: تم تحديثها لتكون أكثر وضوحاً

## كيفية تطبيق الهجرة

### الخطوة 1: تطبيق الهجرة على قاعدة البيانات

```bash
# في مجلد المشروع
cd project

# تطبيق الهجرة الجديدة
npx supabase db push
```

### الخطوة 2: التحقق من التطبيق

بعد تطبيق الهجرة، تأكد من:

1. **حذف الجداول القديمة**: تم حذف جميع الجداول القديمة
2. **إنشاء الجداول الجديدة**: تم إنشاء الجداول بالهيكل الجديد
3. **إعادة تعيين التسلسل**: تم إعادة تعيين العدادات لتبدأ من 1

### الخطوة 3: اختبار النظام

1. **فتح التطبيق**: يجب أن يكون التطبيق فارغاً عند فتحه لأول مرة
2. **زر "ربط"**: 
   - إنشاء حساب جديد
   - التحقق من عدم وجود رقم الحاسبة مسبقاً
   - رفع البيانات المحلية تلقائياً
3. **زر "استعادة"**:
   - التحقق من وجود الحساب
   - حذف البيانات المحلية
   - استعادة البيانات من قاعدة البيانات

## التغييرات في الكود

### 1. ملف الهجرة الجديد
- `supabase/migrations/20250706000001_restructure_database.sql`
- يحذف الجداول القديمة
- ينشئ الجداول الجديدة
- يضبط الفهارس والسياسات

### 2. تحديث ملف database.ts
- تحسين دالة `createUser`
- تحسين دالة `authenticateUser`
- إضافة دالة `connectToDatabase`
- إضافة دالة `restoreFromDatabase`

### 3. تحديث شاشة الإعدادات
- تحسين الرسائل التحذيرية
- تحديث عناوين الأزرار
- تحسين تدفق العمل

### 4. تحديث UserDataContext
- تحسين دالة `restoreFromDatabase`
- تحسين دالة `connectToDatabase`
- تحسين إدارة البيانات المحلية

## ملاحظات مهمة

### ⚠️ تحذير
- **سيتم حذف جميع البيانات الموجودة** في قاعدة البيانات
- **احتفظ بنسخة احتياطية** إذا كنت تريد الاحتفاظ بالبيانات القديمة
- **اختبر النظام** على بيئة تطوير قبل التطبيق على الإنتاج

### ✅ بعد التطبيق
- التطبيق سيعمل بالطريقة المطلوبة
- جميع الرسائل باللغة العربية
- نظام ربط واستعادة محسن
- ID المستخدمين أرقام تسلسلية

## استكشاف الأخطاء

### إذا فشل تطبيق الهجرة:
```bash
# إعادة تعيين قاعدة البيانات
npx supabase db reset

# تطبيق الهجرة مرة أخرى
npx supabase db push
```

### إذا لم تظهر التغييرات:
```bash
# إعادة تشغيل التطبيق
npx expo start --clear
```

## الدعم

إذا واجهت أي مشاكل، تأكد من:
1. تطبيق الهجرة بنجاح
2. إعادة تشغيل التطبيق
3. مسح التخزين المحلي إذا لزم الأمر 